<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Middleware Help | Tomcat</title>
    <meta http-equiv="X-UA-Compatible" content="IE=firefox">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Middleware Notes.">
    <meta property="og:image" content="http://localhost:4000/assets/img/background/og_preview.jpg" />
    <meta property="og:title" content="Tomcat" />
    <meta property="og:description" content="Middleware Notes." />
    <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/highlight.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/cookie-eu-banner.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/custom.css">
    <link rel="canonical" href="http://localhost:4000/docs/tomcat">
    <link rel="shortcut icon" type="image/x-icon" href="http://localhost:4000/assets/favicon.ico" />
    <link rel="alternate" type="application/rss+xml" title="Middleware Tips" href="http://localhost:4000/feed.xml">
</head>

<body>
<div id="container" class="help page help-home background">
    <header>
        <div class="header first ">
            <nav class="greedy">
                <div class="top navigation primary">
                    <ul class="links clearfix">
                        <li class="home with-text"><a href="http://www.passbolt.com/"><span>home</span></a></li>
                        <li class="left"><a href="https://community.passbolt.com/"><span>forum</span></a></li>
                        <li class="left"><a href="https://www.passbolt.com/blog"><span>blog</span></a></li>
                        <li class="left selected"><a href="https://help.passbolt.com/" class="highlighted"><span>help</span></a></li>
                    </ul>
                    <button class="hidden" count="0">more</button>
                    <ul class="hidden-links hidden"></ul>
                </div>
            </nav>
        </div>
    </header>
    <div class="header second">
        <div class="col1">
            <div class="logo no-img">
                <h1><span>Passbolt</span></h1>
            </div>
        </div>
        <div class="col2 search-wrapper">
            <h2 class="visuallyhidden">Help Search</h2>
            <div>
                <form class="search ready" action="/search.html" method="get">
                    <div class="input required">
                        <label for="search-box">Search</label>
                        <input id="search-box" name="query" maxlength="64" placeholder="Help search" class="fuzzy-search" type="search">
                    </div>
                    <button value="search">
                        <i class="fa fa-fw fa-search"></i>
                        <span class="text visuallyhidden">search</span>
                    </button>
                </form>
            </div>
        </div>
        <div class="col3">
            <div class="edit-on-github">
                <a href="https://github.com/miservers/miservers.github.io/edit/master/docs/tomcat.md" class="button">
                    <i class="fa fa-github-alt fa-fw"></i> Edit on github</a>
            </div>
        </div>
    </div>


<div class="panel main">
    <div class="panel left">
        <div class="navigation-help" role="navigation">
    <ul>
        <li><h2>Notes</h2></li>
        
        <li >
            
            	<a href="/docs/menu/app-servers" >App Servers</a>
        	
        </li>
        
        <li >
            
            	<a href="/docs/menu/production" >Production</a>
        	
        </li>
        
        <li >
            
            	<a href="http://localhost:4000/discover">Introduction</a>
            
        </li>
        
        <li >
            
            	<a href="/hosting/install" >Installation</a>
        	
        </li>
        
        <li >
            
            	<a href="http://localhost:4000/hosting">Hosting</a>
            
        </li>
        
        <li >
            
            	<a href="http://localhost:4000/configure">Configure</a>
            
        </li>
        
        <li >
            
            	<a href="http://localhost:4000/extend">Extend</a>
            
        </li>
        
        <li >
            
            	<a href="http://localhost:4000/contribute">Contribute</a>
            
        </li>
        
        <li >
            
            	<a href="http://localhost:4000/legal">Small print</a>
            
        </li>
        
    </ul>
</div>
    </div>

	<div class="panel middle">
		<div class="grid grid-responsive-12">
			<div class="row" id="introduction">
    <div class="col12">
        <div class="breadcrumbs">
            <ul>
                <li>
                    <div class="main-cell">
                        <a href="https://www.passbolt.com"><span>home</span></a>
                    </div>
                </li>
                <li>
                    <div class="main-cell">
                        <a href="/"><span>help</span></a>
                    </div>
                </li>
                
                
                
                
            </ul>
        </div>
    </div>
</div>

			
			<p><strong>Table of content:</strong></p>
<ul>
  <li><a href="#set-up">Set Up</a></li>
  <li><a href="#tomcat-10-administration">Tomcat 10 Administration</a>
    <ul>
      <li><a href="#admin-manager">Admin Manager</a></li>
      <li><a href="#admin-password-encryption">Admin Password Encryption</a></li>
      <li><a href="#realm">Realm</a></li>
      <li><a href="#overload-java-security-policy-or-ext-lib">Overload Java Security Policy or Ext lib</a></li>
      <li><a href="#truststore">TrustStore</a></li>
      <li><a href="#activate-https-tomcat-10">Activate HTTPS (Tomcat 10)</a></li>
      <li><a href="#no-blocking-http-connector---nio-tomcat-6-and-7">No Blocking Http Connector - NIO Tomcat 6 and 7</a></li>
      <li><a href="#logs-rotation">Logs Rotation</a></li>
      <li><a href="#logs">Logs</a></li>
      <li><a href="#valves">Valves</a></li>
      <li><a href="#load-balancing">Load Balancing</a></li>
      <li><a href="#jvmroute">jvmRoute</a></li>
    </ul>
  </li>
  <li><a href="#tomcat-8">Tomcat 8</a>
    <ul>
      <li><a href="#jdbc-connection-pool-oracle">JDBC Connection Pool Oracle</a></li>
      <li><a href="#jdbc-connection-pool-mysql">JDBC Connection Pool MySQL</a></li>
      <li><a href="#activate-https-tomcat-8">Activate HTTPS (Tomcat 8)</a></li>
    </ul>
  </li>
  <li><a href="#tomcat-7">Tomcat 7</a>
    <ul>
      <li>Preventing database connection pool leaks</li>
    </ul>
  </li>
  <li><a href="#tomcat-security">Tomcat Security</a></li>
  <li><a href="#monitoring-performance-tuning">Monitoring Performance Tuning</a></li>
</ul>

<h2 id="set-up">Set Up</h2>
<hr />
<p>HowTo set up Tomcat 10: <a href="https://tomcat.apache.org/tomcat-10.1-doc/RUNNING.txt">RUNNING.txt</a></p>

<h3 id="configure-environment-variables">Configure Environment Variables</h3>
<ul>
  <li>
    <p>CATALINA_HOME(required) : On Linux can be defined in <strong>.bash_profile</strong></p>

    <p>export CATALINA_HOME=/opt/tomcat-10</p>
  </li>
  <li>CATALINA_BASE (optional) : usefull in case of multiple tomcat instance. by default it is equal o CATALINA_HOME.</li>
  <li>JAVA_HOME (required) :</li>
  <li>CATALINA_OPTS (optional) :</li>
  <li>JAVA_OPTS (optional) :</li>
</ul>

<p>Apart from CATALINA_HOME and  CATALINA_BASE, all this variables can be defined in the <strong>setenv</strong> script.</p>

<h3 id="setenv-script">Setenv script</h3>
<p>On *nix, $CATALINA_BASE/bin/setenv.sh:</p>

<p>JRE_HOME=/opt/jdk
  CATALINA_PID=$CATALINA_HOME/run/tomcat.pid</p>

<h3 id="start-tomcat-as-systemd-service">Start Tomcat as systemd Service</h3>
<p>See <a href="./linux-systemd.md">linux-systemd.md</a></p>

<h2 id="tomcat-10-administration">Tomcat 10 Administration</h2>
<hr />
<h3 id="admin-manager">Admin Manager</h3>
<p>http://192.168.56.101:8080/manager/html</p>

<p>Official documentation here : <a href="https://tomcat.apache.org/tomcat-10.0-doc/manager-howto.html">manager-howto</a></p>

<ol>
  <li>To Access the manager from a REMOTE Host, Allow your IP in <ins>context.xml</ins> under tomcat-10/webapps/manager/META-INF/</li>
</ol>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">"org.apache.catalina.valves.RemoteAddrValve"</span> 
  <span class="na">allow=</span><span class="s">"^192.168.56.1$"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<h3 id="password-encryption">Password Encryption</h3>

<p>Generate the encrypted password:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    TOMCAT_HOME/bin/digest.sh <span class="nt">-a</span> sha-256 s3cr3t
    s3cr3t:abb62be83c64497e48608ae0987da<span class="nv">$1$918643e3a75d367b0ad45a34bd67</span>..
</code></pre></div></div>

<p>Modify <ins>server.xml</ins></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Realm</span> <span class="na">className=</span><span class="s">"org.apache.catalina.realm.UserDatabaseRealm"</span> <span class="na">resourceName=</span><span class="s">"UserDatabase"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;CredentialHandler</span> <span class="na">className=</span><span class="s">"org.apache.catalina.realm.MessageDigestCredentialHandler"</span> <span class="na">algorithm=</span><span class="s">"SHA-256"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/Realm&gt;</span>
</code></pre></div></div>

<p>Edit <ins>tomcat-users.xml</ins></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"manager-gui"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;user</span> <span class="na">username=</span><span class="s">"admin123"</span>  <span class="na">password=</span><span class="s">"abb62be83c64497e48608ae0987da$1$918643e3a75d367b0ad45a34bd67..."</span> <span class="na">roles=</span><span class="s">"manager-gui"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Restart Tomcat</p>

<h3 id="realm">Realm</h3>
<p>A Realm is a “database” of usernames and passwords that identify valid users of a web application , and roles (similar to Unix groups) assigned to those users.</p>

<p>Differents implementations of realm can be used:</p>
<ul>
  <li>DataSource Database Realm</li>
  <li>JNDI Directory Realm</li>
  <li>UserDatabase Realm: accesses are defined in <em>conf/tomcat-users.xml</em></li>
  <li>JAAS Realm</li>
</ul>

<p>more informations about realms can be found here <a href="https://tomcat.apache.org/tomcat-8.5-doc/realm-howto.html">Tomcat Realm</a></p>

<h3 id="overload-java-security-policy-or-ext-lib">Overload Java Security Policy or Ext lib</h3>

<p>Add to <em>setenv.sh</em></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">CATALINA_OPTS</span><span class="o">=</span><span class="s2">"... -Djava.ext.dirs=jre/lib/ext -Djava.security.policy=jre/lib/security/java.policy"</span>
</code></pre></div></div>

<h3 id="truststore">TrustStore</h3>

<p>Add this options to <em>CATALINA_OPTS</em></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">-Djavax</span>.net.ssl.trustStore<span class="o">=</span>/path/truststore.jks 
    <span class="nt">-Djavax</span>.net.ssl.trustStorePassword<span class="o">=</span><span class="k">****</span> 
    <span class="nt">-Djavax</span>.net.ssl.trustStoreType<span class="o">=</span>JKS
</code></pre></div></div>

<h3 id="activate-https-tomcat-10">Activate HTTPS (Tomcat 10)</h3>
<p>Uncomment this in <ins>server.xml</ins></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"8443"</span> <span class="na">protocol=</span><span class="s">"org.apache.coyote.http11.Http11NioProtocol"</span>
               <span class="na">maxThreads=</span><span class="s">"150"</span> <span class="na">SSLEnabled=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;UpgradeProtocol</span> <span class="na">className=</span><span class="s">"org.apache.coyote.http2.Http2Protocol"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;SSLHostConfig&gt;</span>
            <span class="nt">&lt;Certificate</span> <span class="na">certificateKeystoreFile=</span><span class="s">"conf/localhost-rsa.jks"</span>
                         <span class="na">type=</span><span class="s">"RSA"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/SSLHostConfig&gt;</span>
<span class="nt">&lt;/Connector&gt;</span>
</code></pre></div></div>

<p>Create a local KeyStore with server’s private key and self signed certificate:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keytool <span class="nt">-genkey</span> <span class="nt">-alias</span> myapp <span class="nt">-keyalg</span> RSA <span class="nt">-keystore</span> myapp-keystore.jks <span class="nt">-keysize</span> 2048 <span class="nt">-validity</span> 365
</code></pre></div></div>

<p>Enable Java(JSSE) Connector(APR is <strong>deprecated</strong>):</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nt">&lt;Connector</span>
	    <span class="na">protocol=</span><span class="s">"org.apache.coyote.http11.Http11NioProtocol"</span>
	    <span class="na">port=</span><span class="s">"8443"</span>
	    <span class="na">maxThreads=</span><span class="s">"150"</span>
	    <span class="na">SSLEnabled=</span><span class="s">"true"</span><span class="nt">&gt;</span>
  		<span class="nt">&lt;SSLHostConfig&gt;</span>
    		<span class="nt">&lt;Certificate</span>
      			<span class="na">certificateKeystoreFile=</span><span class="s">"${user.home}/myapp-keystore.jks"</span>
      			<span class="na">certificateKeystorePassword=</span><span class="s">"changeit"</span>
      			<span class="na">type=</span><span class="s">"RSA"</span>
      		<span class="nt">/&gt;</span>
    	<span class="nt">&lt;/SSLHostConfig&gt;</span>
	<span class="nt">&lt;/Connector&gt;</span>
</code></pre></div></div>

<p>https://192.168.56.101:8443/manager/html</p>

<p>Full Docs : https://tomcat.apache.org/tomcat-10.0-doc/ssl-howto.html</p>

<h3 id="activate-https-tomcat-8">Activate HTTPS (Tomcat 8)</h3>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"10080"</span> <span class="na">protocol=</span><span class="s">"HTTP/1.1"</span>
       <span class="na">connectionTimeout=</span><span class="s">"20000"</span>
       <span class="na">redirectPort=</span><span class="s">"8443"</span> 
       <span class="na">address=</span><span class="s">"safp0180"</span><span class="nt">/&gt;</span>
 
    - NIO Protocol : use JSSE format(keyStore) 
    <span class="nt">&lt;Connector</span>
           <span class="na">protocol=</span><span class="s">"org.apache.coyote.http11.Http11NioProtocol"</span>
           <span class="na">port=</span><span class="s">"8443"</span> <span class="na">maxThreads=</span><span class="s">"200"</span>
           <span class="na">scheme=</span><span class="s">"https"</span> <span class="na">secure=</span><span class="s">"true"</span> <span class="na">SSLEnabled=</span><span class="s">"true"</span>
           <span class="na">keystoreFile=</span><span class="s">"${catalina.base}/conf/ssl/server.jks"</span> <span class="na">keystorePass=</span><span class="s">"changeit"</span>
           <span class="na">clientAuth=</span><span class="s">"false"</span> <span class="na">sslProtocol=</span><span class="s">"TLS"</span><span class="nt">/&gt;</span>
    
    - APR Protocol : use OpenSSL format. Best perfs. but ou must compile!. see below 
    <span class="nt">&lt;Connector</span>
           <span class="na">protocol=</span><span class="s">"org.apache.coyote.http11.Http11AprProtocol"</span>
           <span class="na">port=</span><span class="s">"8443"</span> <span class="na">maxThreads=</span><span class="s">"200"</span>
           <span class="na">scheme=</span><span class="s">"https"</span> <span class="na">secure=</span><span class="s">"true"</span> <span class="na">SSLEnabled=</span><span class="s">"true"</span>
           <span class="na">SSLCertificateFile=</span><span class="s">"${user.home}/conf/ssl/server-cert.pem"</span>
           <span class="na">SSLCertificateKeyFile=</span><span class="s">"${user.home}/conf/ssl/server-key.pem"</span>
           <span class="na">SSLVerifyClient=</span><span class="s">"optional"</span> <span class="na">SSLProtocol=</span><span class="s">"TLS"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"10099"</span> <span class="na">protocol=</span><span class="s">"AJP/1.3"</span> <span class="na">redirectPort=</span><span class="s">"8443"</span> <span class="na">address=</span><span class="s">"safp0180"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<h3 id="no-blocking-http-connector---nio-tomcat-6-and-7">No Blocking Http Connector - NIO Tomcat 6 and 7</h3>

<p>By default, HTTP connector in Tomcat6 and Tomcat7 is blocking connector(BIO). To serve 100 concurrent users,</p>

<p>it requires 100 actives threads(maxThreads if not set, is 200 by default).  To use no blocking connector(NIO):</p>

<pre><code class="language-xmll">   &lt;Connector maxThreads="1000" port="8080" 		
   		protocol="org.apache.coyote.http11.Http11NioProtocol" .../&gt;
</code></pre>

<p>From tomcat8, HTTP connector is NIO by default. wich uses a shared thread pool.</p>

<h3 id="logs-rotation">Logs Rotation</h3>
<p>Install Package</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt install logrotate
</code></pre></div></div>

<p>Configuration: Create a file <strong>/etc/logrotate.d/tomcat</strong> with content:t</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/opt/tomcat-10/logs/catalina.* {
	daily
	dateext   
	copytruncate
	missingok
	rotate 14
	compress
}
</code></pre></div></div>

<p>copytruncate : truncate the original file after coping it. This allow rotating logs with Tomcat running.</p>

<p>missingok: Don’t issue a message error if log file is missing.</p>

<p>Cron daemon launch daily logrotate.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls /etc/cron.daily/
logrotate `
</code></pre></div></div>

<p>Check Config</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>logrotate -d /etc/logrotate.d/tomcat
</code></pre></div></div>

<p>Run logrotate in verbose mode to Test or to Debug problems</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/sbin/logrotate -v /etc/logrotate.conff
</code></pre></div></div>

<h3 id="logs">Logs</h3>
<p><strong>JULI</strong> is the default logging librairy. JULI is an improved implementation of java.util.logging API. Because default implementation of java.logging API has many limitations, for example it is’nt possible to have a per-web application logging.</p>

<p>JULI is enabled by default. Logging can be configured:</p>
<ul>
  <li>Globally. in <ins>${catalina.base}/conf/logging.properties</ins></li>
  <li>Per-web application. <ins>WEB-INF/classes/logging.properties</ins></li>
</ul>

<h3 id="valves">Valves</h3>
<p>A Valve element represents a component that will be inserted into the request processing pipeline for the associated Catalina container (Engine, Host, or Context).</p>

<p>https://tomcat.apache.org/tomcat-10.0-doc/config/valve.html</p>

<p><a href="https://tomcat.apache.org/tomcat-10.0-doc/config/valve.html">List of Valves</a>. Examples:</p>
<ul>
  <li>Access Log Valve</li>
  <li>Remote Address Valve</li>
  <li>Single Sign On Valve</li>
</ul>

<h3 id="load-balancing">Load Balancing</h3>
<h4 id="mod_jk--apache-httpd-and-tomcat">Mod_Jk : Apache HTTPD and Tomcat</h4>
<p>See  <a href="./load-balancing.md">load-balancing.md</a></p>

<h4 id="jvmroute">jvmRoute</h4>
<p>Located in server.xml, it is used by the load balancer to enable session affinity. Il must be unique accros tomcat instances..</p>

<h2 id="tomcat-8">Tomcat 8</h2>
<hr />
<h3 id="jdbc-connection-pool-oracle">JDBC Connection Pool Oracle</h3>
<p>Add to server.xml</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;GlobalNamingResources&gt;</span>
    <span class="nt">&lt;Resource</span> <span class="na">name=</span><span class="s">"jdbc/myDS"</span> <span class="na">auth=</span><span class="s">"Container"</span>
       <span class="na">type=</span><span class="s">"javax.sql.DataSource"</span> <span class="na">driverClassName=</span><span class="s">"oracle.jdbc.OracleDriver"</span>
       <span class="na">url=</span><span class="s">"jdbc:oracle:thin:@127.0.0.1:1521:mysid"</span>
       <span class="na">username=</span><span class="s">"scott"</span> <span class="na">password=</span><span class="s">"tiger"</span> <span class="na">maxTotal=</span><span class="s">"20"</span> <span class="na">maxIdle=</span><span class="s">"10"</span> <span class="na">maxWaitMillis=</span><span class="s">"-1"</span>
	   <span class="na">removeAbandonedTimeout=</span><span class="s">"180"</span> 
       <span class="na">removeAbandoned=</span><span class="s">"true"</span> 
       <span class="na">logAbandoned=</span><span class="s">"true"</span> 
       <span class="na">testOnBorrow=</span><span class="s">"true"</span> 
       <span class="na">validationQuery=</span><span class="s">"SELECT 1"</span>
       <span class="na">factory=</span><span class="s">"org.apache.tomcat.jdbc.pool.DataSourceFactory"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p><strong>Deprecated/New attributes</strong><br />
  maxActive -&gt; maxTotal<br />
  maxWait -&gt; maxWaitMillis</p>

<p><strong>Move from commons-dbcp to tomcat-jdbc-pool</strong>: resolve Already created exception</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">factory</span><span class="o">=</span><span class="s2">"org.apache.tomcat.jdbc.pool.DataSourceFactory"</span>
</code></pre></div></div>

<h3 id="jdbc-connection-pool-mysql">JDBC Connection Pool MySQL</h3>
<p>add to server.xml ou in context.xml(deploy the DS on all applications)</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;GlobalNamingResources&gt;</span>
    <span class="nt">&lt;Resource</span>
    	  <span class="na">name=</span><span class="s">"jdbc/mywikiDS"</span>
    	  <span class="na">auth=</span><span class="s">"Container"</span>
    	  <span class="na">type=</span><span class="s">"javax.sql.DataSource"</span>
    	  <span class="na">factory=</span><span class="s">"org.apache.tomcat.jdbc.pool.DataSourceFactory"</span>
    	  <span class="na">initialSize=</span><span class="s">"10"</span>
    	  <span class="na">maxActive=</span><span class="s">"200"</span>
    	  <span class="na">maxIdle=</span><span class="s">"150"</span>
    	  <span class="na">minIdle=</span><span class="s">"20"</span>
    	  <span class="na">timeBetweenEvictionRunsMillis=</span><span class="s">"34000"</span>
    	  <span class="na">minEvictableIdleTimeMillis=</span><span class="s">"55000"</span>
    	  <span class="na">validationQuery=</span><span class="s">"SELECT 1"</span>
    	  <span class="na">validationInterval=</span><span class="s">"36000"</span>
    	  <span class="na">testOnBorrow=</span><span class="s">"true"</span>
    	  <span class="na">removeAbandoned=</span><span class="s">"true"</span>
    	  <span class="na">removeAbandonedTimeout=</span><span class="s">"60"</span>
          <span class="na">logAbandoned=</span><span class="s">"false"</span> 
          <span class="na">username=</span><span class="s">"mywiki"</span> <span class="na">password=</span><span class="s">"changeit"</span> 
    	  <span class="na">driverClassName=</span><span class="s">"com.mysql.jdbc.Driver"</span>
          <span class="na">url=</span><span class="s">"jdbc:mysql://localhost:3306/mywikidb"</span>
     <span class="nt">/&gt;</span>

   <span class="nt">&lt;Host...&gt;</span>   
    <span class="nt">&lt;Context</span> <span class="na">docBase=</span><span class="s">"simple-jee"</span> <span class="na">path=</span><span class="s">"/simple-jee"</span> <span class="na">reloadable=</span><span class="s">"true"</span><span class="nt">&gt;</span>
	  <span class="nt">&lt;ResourceLink</span> <span class="na">name=</span><span class="s">"jdbc/mywikiDS"</span> <span class="na">global=</span><span class="s">"jdbc/mywikiDS"</span>
                        <span class="na">type=</span><span class="s">"javax.sql.DataSource"</span><span class="nt">/&gt;</span>
 	<span class="nt">&lt;/Context&gt;</span>


</code></pre></div></div>
<p>see : <a href="http://www.codingpedia.org/ama/tomcat-jdbc-connection-pool-configuration-for-production-and-development">http://www.codingpedia.org/ama/tomcat-jdbc-connection-pool-configuration-for-production-and-development</a></p>

<h2 id="tomcat-7">Tomcat 7</h2>
<hr />
<p><strong>Preventing database connection pool leaks</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">removeAbandoned</span><span class="o">=</span><span class="s2">"true"</span>
  <span class="nv">removeAbandonedTimeout</span><span class="o">=</span><span class="s2">"600"</span>
  <span class="nv">logAbandoned</span><span class="o">=</span><span class="s2">"180"</span>
  <span class="nv">removeAbandonedTimeout</span><span class="o">=</span><span class="s2">"600"</span> :  
              en seconds. recyclage des connections. Si trop bas, risque de recycler une 
              connection encore active, car la lecture de ResultSet n<span class="s1">'est pas prise en compte.
								
  logAbandoned="true" : 
              Logging of abandoned connections, adds overhead for every connection borrowing, 
              because a stack trace has to be generated. The default value is false.
</span></code></pre></div></div>

<p><strong>Postgres</strong></p>
<ul>
  <li>Copy the Postgres JDBC jar to $CATALINA_HOME/lib</li>
  <li>Datasource</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Resource</span> <span class="na">name=</span><span class="s">"jdbc/myDS"</span> <span class="na">auth=</span><span class="s">"Container"</span> <span class="na">type=</span><span class="s">"javax.sql.DataSource"</span>
       <span class="na">username=</span><span class="s">"postgres"</span>
       <span class="na">password=</span><span class="s">"postgres"</span>
       <span class="na">driverClassName=</span><span class="s">"org.postgresql.Driver"</span>
       <span class="na">url=</span><span class="s">"jdbc:postgresql://localhost:5432/yourDatabaseName"</span>
       <span class="na">maxTotal=</span><span class="s">"25"</span>
       <span class="na">maxIdle=</span><span class="s">"10"</span>
       <span class="na">validationQuery=</span><span class="s">"select 1"</span> <span class="nt">/&gt;</span> 
</code></pre></div></div>
<ul>
  <li><strong>validationQuery</strong>: validate connections before they are returned to the application. 
needed? When a database server rebo	ots, or there is a network failure!</li>
</ul>

<h2 id="tomcat-security">Tomcat Security</h2>
<hr />

<p>MUST SEE : https://www.owasp.org/index.php/Securing_tomcat</p>

<h3 id="disable-ssl-renegociation">Disable SSL renegociation</h3>
<p>this vulnerability may allow DDOS.<br />
Test if renotiation is enabled</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl s_client -connect localhost:443
[snip... a lot of openssl output]
---
HEAD / HTTP/1.0
R
RENEGOTIATING
28874:error:1409E0E5:SSL routines:SSL3_WRITE_BYTES:ssl handshake failure:s3_pkt.c:530:
</code></pre></div></div>

<p>Enter “HEAD / HTTP/1.0” newline and “R”. if response:</p>
<ul>
  <li>Http request completes, that means that renegotiation is enabled.</li>
  <li>if failure =&gt; renogociation is disabled</li>
  <li>if timeout =&gt; SSL deals with renegociation</li>
</ul>

<p>see : https://blog.ivanristic.com/2009/12/testing-for-ssl-renegotiation.html</p>

<p>To disable renogociation in NIO(style JSSE) protocle, modify connector in server.xml, 
allowUnsafeLegacyRenegotiation=false</p>

<h3 id="eliminate-banner-grabbing-in-apache-tomcat">Eliminate banner grabbing in Apache Tomcat</h3>
<p>Access to http://localhost:8080/notFound will show Tomcat Version (eg Apache Tomcat/8.0). To Eliminate it :</p>

<ol>
  <li>Modify server.xml : add server=”XYZ” property to connector</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   &lt;Connector port="8080" protocol="HTTP/1.1"
	    ...
        server="dServer" /&gt; 
</code></pre></div></div>
<ol>
  <li>Suppress Version from catalina.jar</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backup lib/catalina.jar

jar xf catalina.jar org/apache/catalina/util/ServerInfo.properties
ou
zip -x catalina.jar org/apache/catalina/util/ServerInfo.properties

Replace 
  server.info=Apache Tomcat 8.0.x.x/x
  server.number=8.0.1.2
By
  server.info=
  server.number=0.0.0.0
  
jar uf catalina.jar  org/apache/catalina/util/ServerInfo.properties
ou
zip -u catalina.jar  org/apache/catalina/util/ServerInfo.properties

rm org/apache/catalina/util/ServerInfo.properties

</code></pre></div></div>

<h3 id="suppressing-stacktraces-on-http-500-errors">Suppressing StackTraces on HTTP 500 Errors</h3>
<p>In web.xml, add error-page tag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;error-page&gt;
    &lt;error-code&gt;500&lt;/error-code&gt;
    &lt;location&gt;/WEB-INF/jsp/common/error.jsp&lt;/location&gt;
&lt;/error-page&gt;
</code></pre></div></div>

<h3 id="password-encryption-85-not-tomcat-10-version">Password Encryption (8.5 NOT Tomcat 10 version)</h3>
<p>Generate encrypted password</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./digest.sh -a sha-256 secret
./digest.sh -a md5 secret  : for MD5
</code></pre></div></div>

<p>To use encrypted pasword in <strong>tomcat-users.xml</strong>, add digest to <strong>server.xml</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Realm className="org.apache.catalina.realm.UserDatabaseRealm"
   resourceName="UserDatabase"
   digest="sha-256" /&gt;
</code></pre></div></div>

<p><em>digest.sh</em>  cannot be used to encrypt passwords for DataSource resources</p>

<h3 id="csrf-cross-site-request-forgery">CSRF (Cross-Site Request Forgery)</h3>
<p>manager-gui is protected against CSRF but JMX interface is NOT.</p>

<h2 id="monitoring-performance-tuning">Monitoring Performance Tuning</h2>
<hr />
<p><strong>Activate remote JMX</strong><br />
Edit <em>bin/setenv.sh</em> with:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">CATALINA_OPTS</span><span class="o">=</span><span class="s2">"-Dcom.sun.management.jmxremote </span><span class="se">\</span><span class="s2">
                  -Dcom.sun.management.jmxremote.port=3333 </span><span class="se">\</span><span class="s2">
                  -Dcom.sun.management.jmxremote.ssl=false  </span><span class="se">\</span><span class="s2">
                  -Dcom.sun.management.jmxremote.authenticate=true</span><span class="se">\</span><span class="s2">
                  -Dcom.sun.management.jmxremote.password.file=../conf/jmxremote.password</span><span class="se">\</span><span class="s2">
                  -Dcom.sun.management.jmxremote.access.file=../conf/jmxremote.access"</span>
</code></pre></div></div>
<p>Create files :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ echo "jmxuser readonly" &gt;&gt;  jmxremote.access
$ echo "jmxuser passwd123" &gt;&gt; jmxremote.password 
$ chmod go-rwx jmxremote.password
</code></pre></div></div>

<p>Or Without credentials:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nt">-Dcom</span>.sun.management.jmxremote
	<span class="nt">-Dcom</span>.sun.management.jmxremote.port<span class="o">=</span>6666
	<span class="nt">-Dcom</span>.sun.management.jmxremote.ssl<span class="o">=</span><span class="nb">false</span>
	<span class="nt">-Dcom</span>.sun.management.jmxremote.authenticate<span class="o">=</span><span class="nb">false</span>
</code></pre></div></div>

<p><strong>Probem</strong>: JConsole, connection refused to 127.0.0.1<br />
Solution: add also this option to the remote JVM, -Djava.rmi.server.hostname=hostIp</p>

<p><strong>Simple load test simulation</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ab -n 100000 -c 100 http://localhost:8080/
</code></pre></div></div>

<h3 id="jmx-proxy-servlet">JMX Proxy Servlet</h3>
<p>Prereq:</p>
<ul>
  <li>manager application installed</li>
  <li>role manager-jmx</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat tomcat-users.xml
  <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"manager-jmx"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"manager-gui"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;user</span> <span class="na">username=</span><span class="s">"tomcat"</span> <span class="na">password=</span><span class="s">"changeit"</span> <span class="na">roles=</span><span class="s">"manager-gui,manager-jmx"</span><span class="nt">/&gt;</span>
</code></pre></div></div>
<p>Heap Memory:<br />
<a href="http://localhost:8080/manager/jmxproxy/?get=java.lang:type=Memory&amp;att=HeapMemoryUsage">http://localhost:8080/manager/jmxproxy/?get=java.lang:type=Memory&amp;att=HeapMemoryUsage</a></p>

<p>Query All :<br />
<a href="http://localhost:8080/manager/jmxproxy/?qry=*:*">http://localhost:8080/manager/jmxproxy/?qry=*:*</a></p>

<p>Datasource:<br />
http://localhost:8080/manager/jmxproxy/?qry=Catalina:type=DataSource,host=localhost,context=/examples,
class=javax.sql.DataSource,name=%22jdbc/hellodb%22</p>

<h3 id="monitoring-faq">Monitoring FAQ</h3>
<p><a href="https://wiki.apache.org/tomcat/FAQ/Monitoring">FAQ Monitoring</a></p>

<h3 id="monitoring-using-java-mission-controljmc">Monitoring using Java Mission Control(JMC)</h3>
<h4 id="thread-pool">Thread Pool</h4>
<p>ThreadPool(Not using Executor) :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Catalina:name=http-nio-8080,type=ThreadPool  
Catalina:name=ajp-nio-8080,type=ThreadPool  
attributs:
      currentThreadsBusy
      maxThreads
      currentThreadCount
      connectionCount"
</code></pre></div></div>

<p><img src="images/Tomcat-Thread-Monitoring-By-JMC.png" alt="alt txt" /></p>

<p>Mbean name can be “http-bio-8080” on tomcat 6 &amp; 7.</p>

<p>If using Executor:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JMX Bean: Catalina:type=Executor,name=[executor name]
Attributes: poolSize, activeCount 
</code></pre></div></div>

<p>Recommandation : In Tomcat 7 you must use Executor.</p>

<h4 id="datasource">DataSource</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JMX Bean: Catalina:type=DataSource,context=[context name],
                    host=[hostname],class=javax.sql.DataSource,name="[JNDI name]"
Attributes: numActive, numIdle
</code></pre></div></div>

<p><img src="images/Tomcat-JDBC-Pool-Monitoring-JMC.png" alt="alt txt" /></p>

<h4 id="request-throughput">Request Throughput</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JMX Bean: Catalina:type=GlobalRequestProcessor,name="[depends]"
Attributes: bytesSent, bytesReceived, errorCount, maxTime, requestCount
Operations: resetCounters 
</code></pre></div></div>

<h4 id="sessions">Sessions</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JMX Bean: Catalina:type=Manager,context=[context name],host=[hostname]
Attributes: activeSessions, sessionCounter, expiredSessions
</code></pre></div></div>

<h2 id="tomcat-on-windows">Tomcat on Windows</h2>
<p>Windows service howto: <br />
   https://tomcat.apache.org/tomcat-8.0-doc/windows-service-howto.html</p>

<p>Tomcat Configuring GUI.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  bin/Tomcat8w.exe //ES//‎service-name  (Attention pas despace dans Tomcat 8)
  
</code></pre></div></div>
<p><img src="images/Tomcat-Windows-Config.PNG" alt="alt txt" /></p>


		</div>
	</div>
	
</div>
    <footer>
        <div class="footer">
            <ul class="footer-links">
                <li><a href="https://www.passbolt.com/licence">Terms</a></li>
                <li><a href="https://www.passbolt.com/privacy">Privacy</a></li>
                <li><a href="https://www.passbolt.com/credits">Credits</a></li>
                <li><a href="https://careers.passbolt.com">Careers</a></li>
            </ul>
        </div>
    </footer>
    <div id="cookies-eu-banner" class="visually-hidden">
        🍪 &nbsp; Do you accept cookies for statistical purposes?
        <a href="https://www.passbolt.com/privacy" id="cookies-eu-more">(Read more)</a>
        <a class="button primary" id="cookies-eu-accept">Accept</a>
        <a id="cookies-eu-reject">No thanks!</a>
    </div>


</div>
<script src="https://consent.cookiebot.com/uc.js" data-cbid="900808a8-f178-4994-b2ad-66bf3ccca5f7" data-blockingmode="auto" strategy="beforeInteractive"></script>
<script src="http://localhost:4000/assets/js/matomo-tag-manager.js"></script>
<script src="http://localhost:4000/assets/js/matomo-analytics.js"></script>
<script src="https://code.jquery.com/jquery-3.5.0.slim.min.js" integrity="sha384-/IFzzQmt1S744I+IQO4Mc1uphkxbXt1tEwjQ/qSw2p8pXWck09sLvqHmKDYYwReJ" crossorigin="anonymous"></script>
<script src="http://localhost:4000/assets/js/analytics.js"></script>
<script src="http://localhost:4000/assets/js/greedynav.js"></script>
</body>
</html>
